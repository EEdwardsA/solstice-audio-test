<html>
<title>"Bucket Brigade" Audio Demo</title>
<style>
body {
  max-width: 40em;
}
.warning {
  border: 1px solid red;
  max-width: 30em;
  margin: 1em;
  padding: 1em;
}
#calibration, #runningInstructions, #mainApp {
  display: none;
}
#estQuality {
  background: #eee;
  border-radius: 1em;
  padding: 5em;
  margin: 1em;
  width: calc(100vw - 4em);
  box-sizing: border-box;
}
#est40to60 {
  font-size: 400%;
}
#estLatency {
  font-size: 200%;
}
#startButton, #muteButton {
  font-size: 200%;
}
#activeUsers {
  margin-left: 1em;
}
#chatWindow {
  margin: 1em;
  background: #eee;
}
#chatDisplay {
  padding: 0.25em;
  height: 15em;
  overflow-y: scroll;
}
#chatPost {
  width: 3em;
}
.chatName {
  font-style: italic;
}
#chatEntry {
  width: calc(100% - 3em);
}
#errorBox {
  display: none;
}
#noAudioInputInstructions {
  display: none;

}
</style>
<h1>"Bucket Brigade" Audio Demo</h1>

<div class=warning>

This is a prototype, currently only works in Chrome, and there is only
one active instance. Please be kind! If you're a programmer, I would
recommend opening up devtools so you can see if there are any
interesting console messages.

</div>

Enter your name and press enter:
  <input id=userName></input>

<div id=mainApp>

Input device:
  <select id=inSelect disabled=true>
    <option>Loading...</option>
  </select>
<br>
  Output device:
  <select id=outSelect disabled=true>
    <option>Loading...</option>
  </select>

<p>

<div class=warning id=errorBox></div>

<div id=initialInstructions>
  <ul>
    <li>If you're using Bluetooth headphones, please disconnect them and
      refresh the page.

    <li>If you're using other headphones, take them off your head and
      arrange them so that the microphone is near the ear piece

    <li>When you press start, the system will make some loud beeps,
      because it needs to hear itself.  If the noises are not loud,
      turn up your computer's volume until they are.

    <li style="display: none; color: red" id=bluetoothWarning><b>Your audio device (bluetooth headset?) is triggering a bug. Please let Glenn know you saw this. We will try to work around it automatically.</b>
  </ul>
</div>
<p>
<button id=startButton></button>
<button id=muteButton disabled=true>Mute</button>

<p>

<div id=calibration>

<div id=autoCalibrate1>
  You should be hearing some beeps.

  <ul>
    <li>If you don't hear anything, is your speaker unmuted?
    <li>If you still don't hear anything, try changing your output device above.
    <li>If you do hear beeps but <tt>#beeps detected</tt> is not counting up,
      turn up the volume.
    <li>If the beeps are very loud but it's still not counting up,
      try changing your input device.
    <li>If this is really not working, try clapping along on the beat.
    <li>If the system is still not registering your
      claps, try restarting your browser, or, if that fails,
      restarting your computer.
  </ul>
</div>

<div id=noAudioInputInstructions class=warning>
Mic producing any audio. Is your input device set correctly?
</div>


<p>

  <div id=estQuality>
    <center>
    <span id=est40to60>...</span><br>
    variance<br>
    <br>

    <span id=estLatency>...</span><br>
    latency<br>
    <br>

    <span id=estSamples>...</span><br>
    #beeps detected
    </center>
  </div>

<p>

Click volume: <input id=clickVolumeSlider type=range min=0 max=100
value=100>

</div>

</div>

<div id=runningInstructions>

You're calibrated now!  Everyone is in one big long chain, and your
audio offset chooses where you are in that chain. If you use a smaller
number, more people will be able to hear you, while if you use a
larger number you will be able to hear more people.  The "Take Lead
Position" button puts you at the head of the chain and randomly
assigns positions to everyone else.  The "Jump To End" button moves
you as far late as possible so you can hear what everybody sounded
like singing all together.

<p>

Audio offset (seconds):
<input type=text id=audioOffset value="28">

<p>

<h4>Active Users</h4>

<table id=activeUsers></table>

<h4>Chat</h4>
<div id=chatWindow>
  <div id=chatDisplay></div>
  <form id=chatForm><input type="text" id=chatEntry></input><input type="submit" id=chatPost value="Post"></input></form>
</div>

<button id=takeLead>Take Lead Position</button><br>
<button id=jumpToEnd>Jump To End</button>

</div>

<br>
<br>
<br>
<br>
<br>
<br>

<hr>

<h3>

(<a href="full-instructions.html">background</a>)

<br>

<button type="button" data-otherlabel="Close debug settings" class="collapse">Open debug settings</button>
<div style="display:none">
    Disable latency measurement:
    <input type="checkbox" id="disableLatencyMeasurement">
  <br>
    Loopback mode:
    <select id=loopbackMode>
      <option value=none selected>None (default)</option>
      <option value=worklet>Inside worklet process()</option>
      <option value=main>In main app thread</option>
      <option value=server>Server-side</option>
    </select>
  <br>
    Server path:
    <input type=text id=serverPath value="/api/">
  <br>
    Console log level:
    <select id=logLevel></select>
    <div id=clickParams>(Clicks BPM if selected: <input type=text id=clickBPM value=60>)</div>
    <br>
    Global Volume Control:
    <input type=text id=globalVolumeControl>
    <br>
    Set Mic Volumes:
    <select id=micVolumesUser></select>
    <input type=text id=micVolumeSetting></input>
</div>
<h3>Debug info:</h3>
  Sample rate:
  <input type=text id=sampleRate value="(not available yet)" disabled>
<br>
  Input / output peak absolute amplitude:
  <input type=text id=peakIn value="(not available yet)" disabled>
  <input type=text id=peakOut value="(not available yet)" disabled>
<br>
  This client total time consumed (s):
  <input type=text id=clientTotalTime value="(not available yet)" disabled>
<br>
  This client read slippage (s):
  <input type=text id=clientReadSlippage value="(not available yet)" disabled>
<br>
  Batch size (ms):
  <input type=text id=msBatchSize value="(not available yet)" disabled>
<br>
  Client Latency (ms):
  <input type=text id=msClientLatency value="(not available yet)" disabled>
<br>
  Web Audio Jank (initial) (ms):
  <input type=text id=msWebAudioJank value="(not available yet)" disabled>
<br>
  "True" (de-janked) Latency (ms):
  <input type=text id=msTrueLatency value="(not available yet)" disabled>
<br>
  Web Audio Jank (current) (ms):
  <input type=text id=msWebAudioJankCurrent value="(not available yet)" disabled>
<br>
<br>

</div>

<script type="module" src="./app.js"></script>
</html>
